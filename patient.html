<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Patient Portal</title>

    <style>
      body {
        margin: 0;
        font-family: Arial, sans-serif;
        background: #eef6f9;
      }

      .navbar {
        background: #41837d;
        padding: 15px;
        color: white;
        font-size: 26px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .btn {
        padding: 10px 16px;
        background: #145a56;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
      }
      .btn:hover {
        background: #e63946;
      }

      .container {
        padding: 25px;
      }

      .card {
        background: #fff;
        padding: 20px;
        border-radius: 12px;
        margin-bottom: 25px;
        box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15);
      }

      .title {
        font-size: 26px;
        font-weight: bold;
        margin-bottom: 10px;
        color: #145a56;
      }

      input,
      select,
      textarea {
        width: 100%;
        padding: 10px;
        margin-top: 8px;
        margin-bottom: 15px;
        border-radius: 6px;
        border: 1px solid #bbb;
      }

      .doctor-card {
        padding: 12px;
        border-radius: 8px;
        background: #f7ffff;
        border: 1px solid #b8e6e1;
        margin-bottom: 10px;
      }
    </style>
  </head>

  <body>
    <!-- NAVBAR -->
    <div class="navbar">
      <span><b>Patient Dashboard</b></span>
      <button class="btn" onclick="logout()">Logout</button>
    </div>

    <div class="container">
      <!-- Welcome -->
      <div class="card">
        <div class="title">Welcome, <span id="patientName"></span></div>
        <p>Your health is our priority.</p>
      </div>

      <!-- Profile -->
      <div class="card">
        <h3>Your Profile</h3>
        <div id="profileData">Loading...</div>
      </div>

      <!-- Appointment Form -->
      <div class="card">
        <h3>Book an Appointment</h3>

        <label>Select Doctor</label>
        <select id="doctorSelect" required>
          <option disabled>Loading doctors...</option>
        </select>

        <label>Preferred Date</label>
        <input type="date" id="apptDate" />

        <label>Your Symptoms</label>
        <textarea id="symptoms" rows="3"></textarea>

        <label>Description</label>
        <textarea id="description" rows="4"></textarea>

        <button class="btn" onclick="bookAppointment()">Submit</button>

        <p id="appointmentMsg" style="color: green"></p>
      </div>

      <!-- Doctor Search -->
      <div class="card">
        <h3>Search Doctors</h3>

        <label>Max Budget (₹)</label>
        <input type="number" id="budget" placeholder="Ex: 500" />

        <label>Minimum Experience (Years)</label>
        <input type="number" id="experience" placeholder="Ex: 5" />

        <label>Location</label>
        <input type="text" id="location" placeholder="Enter city" />

        <button class="btn" onclick="searchDoctors()">Search</button>

        <div id="searchResults" style="margin-top: 15px"></div>
      </div>

      <!-- Appointments -->
      <div class="card">
        <h3>Your Appointments</h3>
        <div id="appointments">Loading...</div>
      </div>
    </div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script>
      // Firebase Config
      const firebaseConfig = {
        apiKey: "AIzaSyBtBFAFl1zK0j8IaVxx-WWOv6mJA_9sScM",
        authDomain: "medicare-for-you.firebaseapp.com",
        projectId: "medicare-for-you",
        storageBucket: "medicare-for-you.firebasestorage.app",
        messagingSenderId: "14599880310",
        appId: "1:14599880310:web:22e826783c0fa6d97fa957",
        measurementId: "G-3H5CQHK77Z",
      };

      firebase.initializeApp(firebaseConfig);
      const auth = firebase.auth();
      const db = firebase.firestore();

      let currentUser = null;

      // ---------------------------
      // CHECK LOGIN & LOAD PROFILE + DOCTORS
      // ---------------------------
      auth.onAuthStateChanged(async (user) => {
        if (!user) return (window.location.href = "index.html");

        currentUser = user;
        const uid = user.uid;

        try {
          // Load Patient Profile
          // Query the "users" collection for the current user with role = "patient"
          const userQuery = await db
            .collection("users")
            .where(firebase.firestore.FieldPath.documentId(), "==", uid)
            .where("role", "==", "patient")
            .get();

          if (userQuery.empty) {
            throw new Error("Patient data not found in users collection");
          }

          const data = userQuery.docs[0].data();

          document.getElementById("patientName").innerText = data.name;
          document.getElementById("profileData").innerHTML = `
            <b>Name:</b> ${data.name}<br>
            <b>Age:</b> ${data.age}<br>
            <b>Gender:</b> ${data.gender}<br>
            <b>Phone:</b> ${data.phone}<br>
          `;

          // Load Appointments
          loadAppointments();

          // Load Doctors Dropdown (Real-time with debug)
          const select = document.getElementById("doctorSelect");
          select.innerHTML = `<option disabled>Loading doctors...</option>`;

          // Try lowercase first
          let collectionRef = db.collection("doctors");
          collectionRef.get().then((snapshot) => {
            if (snapshot.empty) {
              // Try uppercase "Doctors"
              collectionRef = db.collection("Doctors");
            }
            collectionRef.onSnapshot(
              (snapshot) => {
                console.log(
                  "Doctors snapshot:",
                  snapshot.docs.map((d) => d.data())
                ); // Debug
                select.innerHTML = "";
                if (snapshot.empty) {
                  select.innerHTML = `<option disabled>No doctors available</option>`;
                  return;
                }
                snapshot.forEach((doc) => {
                  const d = doc.data();
                  if (d.name && d.specialization) {
                    const option = document.createElement("option");
                    option.value = doc.id;
                    option.textContent = `${d.name} (${d.specialization})`;
                    select.appendChild(option);
                  }
                });
              },
              (err) => {
                console.error("Error loading doctors:", err);
                select.innerHTML = `<option disabled>Error loading doctors</option>`;
              }
            );
          });
        } catch (err) {
          console.error("Error loading patient data:", err);
        }
      });

      // ---------------------------
      // LOAD APPOINTMENTS
      // ---------------------------
      async function loadAppointments() {
        const ref = await db
          .collection("appointments")
          .where("patientId", "==", currentUser.uid)
          .get();

        if (ref.empty) {
          document.getElementById("appointments").innerText =
            "No appointments yet.";
          return;
        }

        let html = "";
        ref.forEach((doc) => {
          let a = doc.data();
          html += `
            <div style="padding:10px;border-bottom:1px solid #ccc;">
              <b>Doctor:</b> ${a.doctorName}<br>
              <b>Date:</b> ${a.date}<br>
              <b>Status:</b> ${a.status}
            </div>
          `;
        });

        document.getElementById("appointments").innerHTML = html;
      }

      // ---------------------------
      // BOOK APPOINTMENT
      // ---------------------------
      async function bookAppointment() {
        let doctorId = document.getElementById("doctorSelect").value;
        let date = document.getElementById("apptDate").value;
        let symptoms = document.getElementById("symptoms").value;
        let desc = document.getElementById("description").value;

        if (!doctorId || !date || !symptoms) {
          alert("Please fill all fields!");
          return;
        }

        const docRef = await db.collection("Doctors").doc(doctorId).get();
        const doctorData = docRef.data();

        await db.collection("appointments").add({
          doctorId,
          doctorName: doctorData.name,
          patientId: currentUser.uid,
          patientName: document.getElementById("patientName").innerText,
          date,
          symptoms,
          description: desc,
          status: "Pending",
        });

        document.getElementById("appointmentMsg").innerText =
          "Appointment Submitted!";
        loadAppointments();
      }

      // ---------------------------
      // SEARCH DOCTORS
      // ---------------------------
      async function searchDoctors() {
        let budget = document.getElementById("budget").value;
        let exp = document.getElementById("experience").value;
        let loc = document.getElementById("location").value.toLowerCase();

        const ref = await db.collection("Doctors").get();

        let results = [];

        ref.forEach((doc) => {
          const d = doc.data();

          if (budget && d.fees > budget) return;
          if (exp && d.experience < exp) return;
          if (loc && d.location.toLowerCase() !== loc) return;

          results.push(d);
        });

        let html = "";
        results.forEach((d) => {
          html += `
            <div class="doctor-card">
              <b>${d.name}</b> (${d.specialization})<br>
              Fees: ₹${d.fees}<br>
              Experience: ${d.experience} yrs<br>
              Location: ${d.location}<br>
            </div>
          `;
        });

        document.getElementById("searchResults").innerHTML = results.length
          ? html
          : "No doctors found.";
      }

      // ---------------------------
      // LOGOUT
      // ---------------------------
      function logout() {
        auth.signOut().then(() => (window.location.href = "index.html"));
      }
    </script>
  </body>
</html>
