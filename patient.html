<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Patient Portal</title>

    <!-- Leaflet (Free Map) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <style>
      body {
        margin: 0;
        font-family: Arial, sans-serif;
        background: #eef6f9;
      }

      .navbar {
        background: #41837d;
        padding: 15px;
        color: white;
        font-size: 26px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .btn {
        padding: 10px 16px;
        background: #145a56;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
      }
      .btn:hover {
        background: #e63946;
      }

      .container {
        padding: 25px;
      }

      .card {
        background: #fff;
        padding: 20px;
        border-radius: 12px;
        margin-bottom: 25px;
        box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15);
      }

      .title {
        font-size: 26px;
        font-weight: bold;
        margin-bottom: 10px;
        color: #145a56;
      }

      input,
      select,
      textarea {
        width: 100%;
        padding: 10px;
        margin-top: 8px;
        margin-bottom: 15px;
        border-radius: 6px;
        border: 1px solid #bbb;
      }

      #suggestions div:hover {
        background: #f0f0f0;
      }

      #medicineMap {
        height: 350px;
        border-radius: 10px;
        margin-top: 15px;
      }
    </style>
  </head>

  <body>
    <div class="navbar">
      <span><b>Patient Dashboard</b></span>
      <button class="btn" onclick="logout()">Logout</button>
    </div>

    <div class="container">
      <!-- Welcome -->
      <div class="card">
        <div class="title">Welcome, <span id="patientName"></span></div>
        <p>Your health is our priority.</p>
      </div>

      <!-- MEDICINE SEARCH SECTION -->
      <div class="card">
        <h3>Search Medicines (Alternative to Appointment)</h3>

        <input
          type="text"
          id="altDisease"
          placeholder="Enter disease (e.g. Fever)"
          oninput="showSuggestions()"
        />

        <div
          id="suggestions"
          style="
            background: white;
            border: 1px solid #ccc;
            border-radius: 6px;
            max-height: 150px;
            overflow-y: auto;
            margin-bottom: 10px;
          "
        ></div>

        <button class="btn" onclick="searchAltMedicine()">Search</button>

        <div id="altMedicineResult"></div>
        <div id="medicineMap"></div>
      </div>

      <!-- APPOINTMENT FORM -->
      <div class="card">
        <h3>Book an Appointment</h3>

        <label>Select Doctor</label>
        <select id="doctorSelect"></select>

        <label>Preferred Date</label>
        <input type="date" id="apptDate" />

        <label>Your Symptoms</label>
        <textarea id="symptoms"></textarea>

        <label>Description</label>
        <textarea id="description"></textarea>

        <button class="btn" onclick="bookAppointment()">Submit</button>
        <p id="appointmentMsg" style="color: green"></p>
      </div>

      <!-- APPOINTMENTS LIST -->
      <div class="card">
        <h3>Your Appointments</h3>
        <div id="appointments"></div>
      </div>
    </div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script>
      const firebaseConfig = {
        apiKey: "AIzaSyBtBFAFl1zK0j8IaVxx-WWOv6mJA_9sScM",
        authDomain: "medicare-for-you.firebaseapp.com",
        projectId: "medicare-for-you",
        storageBucket: "medicare-for-you.firebasestorage.app",
        messagingSenderId: "14599880310",
        appId: "1:14599880310:web:22e826783c0fa6d97fa957",
        measurementId: "G-3H5CQHK77Z",
      };

      firebase.initializeApp(firebaseConfig);
      const auth = firebase.auth();
      const db = firebase.firestore();

      let currentUser = null;
      let medMap = null;

      auth.onAuthStateChanged(async (user) => {
        if (!user) return (window.location.href = "index.html");

        currentUser = user;

        const snap = await db.collection("users").doc(user.uid).get();
        document.getElementById("patientName").innerText = snap.data().name;

        loadDoctors();
        loadAppointments();
      });

      function logout() {
        auth.signOut().then(() => (window.location.href = "index.html"));
      }

      function scrollToAppointment() {
        document
          .getElementById("doctorSelect")
          .scrollIntoView({ behavior: "smooth" });
      }

      /* =======================
   AUTO SUGGESTIONS
======================= */
      async function showSuggestions() {
        const input = document
          .getElementById("altDisease")
          .value.trim()
          .toLowerCase();

        const suggestionBox = document.getElementById("suggestions");

        if (!input) {
          suggestionBox.innerHTML = "";
          return;
        }

        const snapshot = await db.collection("medicines").get();
        let matches = [];

        snapshot.forEach((doc) => {
          const data = doc.data();
          if (data.diseaseLower.includes(input)) {
            matches.push(data.disease);
          }
        });

        suggestionBox.innerHTML = matches
          .map(
            (d) =>
              `<div style="padding:8px;cursor:pointer;"
          onclick="selectSuggestion('${d}')">${d}</div>`,
          )
          .join("");
      }

      function selectSuggestion(disease) {
        document.getElementById("altDisease").value = disease;
        document.getElementById("suggestions").innerHTML = "";
        searchAltMedicine();
      }

      /* =======================
   MEDICINE SEARCH
======================= */
      async function searchAltMedicine() {
        const diseaseInput = document
          .getElementById("altDisease")
          .value.trim()
          .toLowerCase();

        if (!diseaseInput) return alert("Enter disease.");

        const snapshot = await db
          .collection("medicines")
          .where("diseaseLower", "==", diseaseInput)
          .get();

        if (snapshot.empty) {
          document.getElementById("altMedicineResult").innerHTML =
            "<p>No data found.</p>";
          return;
        }

        const data = snapshot.docs[0].data();

        document.getElementById("altMedicineResult").innerHTML = `
    <div style="background:#f7ffff;border:1px solid #b8e6e1;
                padding:15px;border-radius:8px;margin-top:15px;">
      <b>Disease:</b> ${data.disease}<br><br>
      <b>Suggested Medicines:</b><br>
      ${data.medicines.map((m) => "â€¢ " + m).join("<br>")}
      <br><br>
      <b>Precautions:</b><br>
      ${data.precautions}
      <br><br>
      <button class="btn" onclick="scrollToAppointment()">
        Consult Doctor
      </button>
    </div>
  `;

        loadPharmacyMap();
      }

      /* =======================
   FREE PHARMACY MAP
======================= */
      function loadPharmacyMap() {
        if (!navigator.geolocation) return;

        navigator.geolocation.getCurrentPosition((position) => {
          const lat = position.coords.latitude;
          const lon = position.coords.longitude;

          if (medMap) medMap.remove();

          medMap = L.map("medicineMap").setView([lat, lon], 14);

          L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            attribution: "&copy; OpenStreetMap contributors",
          }).addTo(medMap);

          L.marker([lat, lon])
            .addTo(medMap)
            .bindPopup("You are here")
            .openPopup();

          const overpassUrl = `https://overpass-api.de/api/interpreter?data=[out:json];
       node["amenity"="pharmacy"](around:3000,${lat},${lon});out;`;

          fetch(overpassUrl)
            .then((res) => res.json())
            .then((data) => {
              data.elements.forEach((place) => {
                if (place.lat && place.lon) {
                  L.marker([place.lat, place.lon])
                    .addTo(medMap)
                    .bindPopup(place.tags.name || "Pharmacy");
                }
              });
            });
        });
      }

      /* =======================
   DOCTORS & APPOINTMENTS
======================= */
      async function loadDoctors() {
        const snapshot = await db.collection("Doctors").get();
        const select = document.getElementById("doctorSelect");
        select.innerHTML = "";

        snapshot.forEach((doc) => {
          const d = doc.data();
          const option = document.createElement("option");
          option.value = doc.id;
          option.textContent = `${d.name} (${d.specialization})`;
          select.appendChild(option);
        });
      }

      async function loadAppointments() {
        const ref = await db
          .collection("appointments")
          .where("patientId", "==", currentUser.uid)
          .get();

        if (ref.empty) {
          document.getElementById("appointments").innerText =
            "No appointments yet.";
          return;
        }

        let html = "";
        ref.forEach((doc) => {
          const a = doc.data();
          html += `
      <div style="padding:10px;border-bottom:1px solid #ccc;">
        <b>Doctor:</b> ${a.doctorName}<br>
        <b>Date:</b> ${a.date}<br>
        <b>Status:</b> ${a.status}
      </div>`;
        });

        document.getElementById("appointments").innerHTML = html;
      }

      async function bookAppointment() {
        const doctorId = document.getElementById("doctorSelect").value;
        const date = document.getElementById("apptDate").value;
        const symptoms = document.getElementById("symptoms").value;
        const desc = document.getElementById("description").value;

        if (!doctorId || !date || !symptoms)
          return alert("Fill required fields.");

        const docRef = await db.collection("Doctors").doc(doctorId).get();
        const doctorData = docRef.data();

        await db.collection("appointments").add({
          doctorId,
          doctorName: doctorData.name,
          patientId: currentUser.uid,
          patientName: document.getElementById("patientName").innerText,
          date,
          symptoms,
          description: desc,
          status: "Pending",
        });

        document.getElementById("appointmentMsg").innerText =
          "Appointment Submitted!";
        loadAppointments();
      }
    </script>
  </body>
</html>
